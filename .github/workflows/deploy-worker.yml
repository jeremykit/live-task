name: Deploy Cloudflare Worker

on:
  workflow_dispatch:
    inputs:
      notes:
        description: "Optional note for this deployment"
        required: false
        default: "manual trigger"

jobs:
  deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Inject secrets into wrangler.toml
        working-directory: worker
        env:
          SERVER_ALIAS_LIST: ${{ secrets.SERVER_ALIAS_LIST }}
          SERVER_URL_LIST: ${{ secrets.SERVER_URL_LIST }}
          SERVER_TOKEN: ${{ secrets.SERVER_TOKEN }}
          LIVE_NAME_LIST: ${{ secrets.LIVE_NAME_LIST }}
          WECHAT_WEBHOOK_KEY: ${{ secrets.WECHAT_WEBHOOK_KEY }}
        run: |
          python - <<'PY'
          import os
          from pathlib import Path

          path = Path("wrangler.toml")
          data = path.read_text()
          replacements = {
              "__SERVER_ALIAS_LIST__": os.environ.get("SERVER_ALIAS_LIST", ""),
              "__SERVER_URL_LIST__": os.environ.get("SERVER_URL_LIST", ""),
              "__SERVER_TOKEN__": os.environ.get("SERVER_TOKEN", ""),
              "__LIVE_NAME_LIST__": os.environ.get("LIVE_NAME_LIST", ""),
              "__WECHAT_WEBHOOK_KEY__": os.environ.get("WECHAT_WEBHOOK_KEY", ""),
          }

          for placeholder, value in replacements.items():
              data = data.replace(placeholder, value)

          path.write_text(data)
          PY

      - name: Publish Worker to Cloudflare
        uses: cloudflare/wrangler-action@v3
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          workingDirectory: worker
          command: deploy
